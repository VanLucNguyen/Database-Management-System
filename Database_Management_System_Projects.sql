--DATABASE
CREATE DATABASE EMETRO
USE EMETRO
--
DROP DATABASE EMETRO
--
--Phân quyền 

--ADMIN
--Tạo tài khoản login ADMIN
CREATE LOGIN ADMIN WITH PASSWORD = 'ADMIN'
--Tạo user ADMIN trong database EMETRO sử dùng tài khoản ADMIN login
USE EMETRO
CREATE USER ADMIN FOR LOGIN ADMIN
--Gán quyền db_owner cho ADMIN
USE EMETRO
GO
ALTER ROLE [db_owner] ADD MEMBER ADMIN
GO


--Nhân viên công ty
--Tạo tài khoản login NVCT
CREATE LOGIN NVCT WITH PASSWORD = 'NVCT'
--Tạo user NVCT trong database EMETRO sử dùng tài khoản NVCT login
USE EMETRO
CREATE USER NVCT FOR LOGIN NVCT
--Gán quyền cho nhân viên công ty
GRANT INSERT, UPDATE, SELECT ON TUYEN_TAU TO NVCT
GRANT INSERT, UPDATE, SELECT ON TUYEN_TOC_HANH TO NVCT
GRANT INSERT, UPDATE, SELECT ON DIEM_DUNG TO NVCT
GRANT EXECUTE ON PROC_DUNG_TRAM TO NVCT

--

--Nhân viên Sở GTTP
--Tạo tài khoản login NVSGTTP
CREATE LOGIN NVSGTTP WITH PASSWORD = 'NVSGTTP'
--Tạo user NVSGTTP trong database EMETRO sử dùng tài khoản NVSGTTP login
USE EMETRO
CREATE USER NVSGTTP FOR LOGIN NVSGTTP
--Gán quyền cho nhân viên Sở GTTP
GRANT INSERT, UPDATE, SELECT ON CTY_TAU_CAO_TOC TO NVSGTTP
GRANT INSERT, UPDATE, SELECT ON GA TO NVSGTTP
GRANT INSERT, UPDATE, SELECT ON BAN_DO TO NVSGTTP

--

--Nhân viên bán vé
--Tạo tài khoản login NVBV
CREATE LOGIN NVBV WITH PASSWORD = 'NVBV'
--Tạo user NVBV trong database EMETRO sử dụng tài khoản NVBV login
USE EMETRO
CREATE USER NVBV FOR LOGIN NVBV
--Gán quyền cho nhân viên bán vé
GRANT SELECT ON GA TO NVBV
GRANT SELECT ON TUYEN_TAU TO NVBV
GRANT SELECT ON KHUYEN_MAI TO NVBV
GRANT INSERT, SELECT, DELETE ON VE TO NVBV
GRANT INSERT, SELECT ON VE_THUONG TO NVBV
GRANT INSERT, SELECT ON VE_THANG TO NVBV
GRANT INSERT, SELECT ON BAO_CAO TO NVBV
GRANT INSERT, DELETE, SELECT ON KHACH_HANG TO NVBV
GRANT EXECUTE ON PROC_TONG_DT TO NVBV

--

--Cổng kiểm soát vé tự động
--Tạo tài khoản login CKSVTD
CREATE LOGIN CKSVTD WITH PASSWORD = 'CKSVTD'
--Tạo user CKSVTD trong database EMETRO sử dụng tài khoản CKSVTD login
USE EMETRO
CREATE USER CKSVTD FOR LOGIN CKSVTD
--Gán quyền cho cổng kiểm soát vé tự động
GRANT SELECT ON VE TO CKSVTD
GRANT SELECT ON VE_THUONG TO CKSVTD
GRANT SELECT ON VE_THANG TO CKSVTD
GRANT INSERT ON THOI_DIEM_SU_DUNG TO CKSVTD
GRANT EXECUTE ON PROC_TT_VETHUONG TO CKSVTD
GRANT EXECUTE ON PROC_TT_VETHANG TO CKSVTD


--TABLE

--Công ty tàu cao tốc
CREATE TABLE CTY_TAU_CAO_TOC
(
	MA_CTY CHAR(4) PRIMARY KEY,
	TEN_CTY NVARCHAR(100),
	WEBSITE VARCHAR(100),
	DIA_CHI NVARCHAR(100),
	SDT VARCHAR(100)
)

--Ga
CREATE TABLE GA
(
	MA_GA CHAR(4) PRIMARY KEY,
	TEN_GA NVARCHAR(100),
	VI_TRI NVARCHAR(100),
	TINH_TRANG_GA NVARCHAR(100)
)

--Tuyến tàu
CREATE TABLE TUYEN_TAU
(
	MA_TUYEN CHAR(4) PRIMARY KEY,
	TEN_TUYEN NVARCHAR(100),
	MA_CTY CHAR(4),
	MA_GA_XUAT_PHAT CHAR(4),
	MA_GA_KET_THUC CHAR(4),
	LOAI_TUYEN NVARCHAR(100),
	GIA_TUYEN MONEY,
	TINH_TRANG_TUYEN NVARCHAR(100),
	THOI_GIAN_BAT_DAU VARCHAR(100),
	THOI_GIAN_KET_THUC VARCHAR(100),
	THOI_GIAN_CHO VARCHAR(100)
)

--Tuyến tốc hành
CREATE TABLE TUYEN_TOC_HANH
(
	MA_TUYEN CHAR(4) PRIMARY KEY,
	DUNG_TRAM BIT
)

--Bản đồ
CREATE TABLE BAN_DO
(
  MA_BD CHAR(4) PRIMARY KEY,
  MA_GA CHAR(4),
  HINH_ANH NVARCHAR(1000)
)

--Điểm dừng
CREATE TABLE DIEM_DUNG
(
  MA_GA CHAR(4) ,
  MA_TUYEN CHAR(4),
  THOI_GIAN_DUNG VARCHAR(100),
  CONSTRAINT PK_DIEM_DUNG PRIMARY KEY (MA_GA, MA_TUYEN)
)

--Vé
CREATE TABLE VE
(
  MA_VE CHAR(4) PRIMARY KEY,
  TRI_GIA MONEY,
  MA_TUYEN CHAR(4),
  NGAY_MUA SMALLDATETIME,
  MA_KM CHAR(4),
  MA_KH CHAR(4),
  MA_NV CHAR(4),
  LOAI_VE NVARCHAR(100)
)

--Vé thường
CREATE TABLE VE_THUONG
(
  MA_VE CHAR(4) PRIMARY KEY,
  THOI_DIEM_DUNG_VE SMALLDATETIME,
  TINH_TRANG_VE		(100),
  MA_KH CHAR(4)
)

--Vé tháng
CREATE TABLE VE_THANG
(
  MA_VE CHAR(4) PRIMARY KEY,
  SO_LAN_SU_DUNG INT,
  TINH_TRANG_VE NVARCHAR(100),
  NGAY_BAT_DAU SMALLDATETIME,
  NGAY_KET_THUC SMALLDATETIME,
  MA_KH CHAR(4)
)

--Thời điểm sử dụng
CREATE TABLE THOI_DIEM_SU_DUNG
(
  MA_TD  INT IDENTITY(1,1) PRIMARY KEY,	
  MA_VE CHAR(4) ,
  NGAY SMALLDATETIME
)

--Nhân viên
CREATE TABLE NHAN_VIEN
(
	MA_NV CHAR(4) PRIMARY KEY,
	HO_TEN NVARCHAR(100),
	LOAI_NV NVARCHAR(100),
	TAI_KHOAN VARCHAR(100),
	MAT_KHAU VARCHAR(100),
	MA_CTY CHAR(4),
	MA_GA CHAR(4),
	MA_TUYEN CHAR(4)
)

--Khuyến mãi
CREATE TABLE KHUYEN_MAI
(
	MA_KM CHAR(4) PRIMARY KEY,
	NOI_DUNG NVARCHAR(100),
	PHAN_TRAM_KM DECIMAL(3, 2),
	LOAI_DT NVARCHAR(100)
)

--Khách hàng
CREATE TABLE KHACH_HANG
(
	MA_KH CHAR(4) PRIMARY KEY,
	HO_TEN NVARCHAR(100),
	SDT VARCHAR(100),
	CMND VARCHAR(100),
	LOAI_KH NVARCHAR(100)
)

--Báo cáo
CREATE TABLE BAO_CAO
(
	MA_BC CHAR(4) PRIMARY KEY,
	NGAY_LAP SMALLDATETIME,
	NGAY_BD SMALLDATETIME,
	NGAY_KT SMALLDATETIME,
	NOI_DUNG NVARCHAR(100),
	TONG_DOANH_THU MONEY,
	MA_NV CHAR(4)
)

--FOREIGN KEY

--Tuyến tàu
ALTER TABLE TUYEN_TAU ADD FOREIGN KEY(MA_CTY) REFERENCES CTY_TAU_CAO_TOC(MA_CTY)
ALTER TABLE TUYEN_TAU ADD FOREIGN KEY(MA_GA_XUAT_PHAT) REFERENCES GA(MA_GA)
ALTER TABLE TUYEN_TAU ADD FOREIGN KEY(MA_GA_KET_THUC) REFERENCES GA(MA_GA)
--Nhân viên
ALTER TABLE NHAN_VIEN ADD FOREIGN KEY(MA_CTY) REFERENCES CTY_TAU_CAO_TOC(MA_CTY)
ALTER TABLE NHAN_VIEN ADD FOREIGN KEY(MA_GA) REFERENCES GA(MA_GA)
ALTER TABLE NHAN_VIEN ADD FOREIGN KEY(MA_TUYEN) REFERENCES TUYEN_TAU(MA_TUYEN)
--Tuyến tốc hành
ALTER TABLE TUYEN_TOC_HANH ADD FOREIGN KEY(MA_TUYEN) REFERENCES TUYEN_TAU(MA_TUYEN)
--Vé
ALTER TABLE VE ADD FOREIGN KEY(MA_TUYEN) REFERENCES TUYEN_TAU(MA_TUYEN)
ALTER TABLE VE ADD FOREIGN KEY(MA_KH) REFERENCES KHACH_HANG(MA_KH)
ALTER TABLE VE ADD FOREIGN KEY(MA_KM) REFERENCES KHUYEN_MAI(MA_KM)
ALTER TABLE VE ADD FOREIGN KEY(MA_NV) REFERENCES NHAN_VIEN(MA_NV)
--Điểm dừng
ALTER TABLE DIEM_DUNG ADD FOREIGN KEY(MA_GA) REFERENCES GA(MA_GA)
ALTER TABLE DIEM_DUNG ADD FOREIGN KEY(MA_TUYEN) REFERENCES TUYEN_TAU(MA_TUYEN)
--Bản đồ
ALTER TABLE BAN_DO ADD FOREIGN KEY(MA_GA) REFERENCES GA(MA_GA)
--Vé thường
ALTER TABLE VE_THUONG ADD FOREIGN KEY(MA_VE) REFERENCES VE(MA_VE)
ALTER TABLE VE_THUONG ADD FOREIGN KEY(MA_KH) REFERENCES KHACH_HANG(MA_KH)
--Vé tháng 
ALTER TABLE VE_THANG ADD FOREIGN KEY(MA_KH) REFERENCES KHACH_HANG(MA_KH)
ALTER TABLE VE_THANG ADD FOREIGN KEY(MA_VE) REFERENCES VE(MA_VE)
--Thời điểm sử dụng
ALTER TABLE THOI_DIEM_SU_DUNG ADD FOREIGN KEY(MA_VE) REFERENCES VE_THANG(MA_VE)
 --Báo cáo
ALTER TABLE BAO_CAO ADD FOREIGN KEY (MA_NV) REFERENCES NHAN_VIEN (MA_NV)


--CONSTRAINT

--Ga
ALTER TABLE GA ADD CHECK (TINH_TRANG_GA IN(N'Bình thường', N'Đang sửa chữa', N'Ngừng hoạt động'))
--Tuyến tàu
ALTER TABLE TUYEN_TAU ADD CHECK (TINH_TRANG_TUYEN IN(N'Hoạt động', N'Không hoạt động'))
ALTER TABLE TUYEN_TAU ADD CHECK (GIA_TUYEN >=25000)
ALTER TABLE TUYEN_TAU ADD CHECK (LOAI_TUYEN IN (N'Tuyến thường', N'Tuyến tốc hành'))
--Vé tháng
ALTER TABLE VE_THANG ADD CHECK ((DATEDIFF(DAY, NGAY_BAT_DAU, NGAY_KET_THUC))<=30)
--Khách hàng
ALTER TABLE KHACH_HANG ADD CHECK (LOAI_KH IN(N'HS-SV', N'Người cao tuổi (>65)', N'Trẻ em (5-10)', N'Trẻ nhỏ (<5)', N'Người khuyết tật'))
--Vé
ALTER TABLE VE ADD CHECK (LOAI_VE IN(N'Vé thường', N'Vé tháng'))
ALTER TABLE VE_THUONG ADD CHECK (TINH_TRANG_VE IN(N'Đã sử dụng', N'Chưa sử dụng'))
ALTER TABLE VE_THANG ADD CHECK (TINH_TRANG_VE IN(N'Còn hạn', N'Hết hạn'))
--Nhân viên
ALTER TABLE NHAN_VIEN ADD CHECK (LOAI_NV IN(N'Nhân viên bán vé', N'Nhân viên công ty', N'Nhân viên sở GTTP'))

--TRIGGER

--Ngày kết thúc của vé tháng 
GO
CREATE TRIGGER TRIG_NGAYKT ON VE_THANG
FOR INSERT, UPDATE, DELETE
AS
BEGIN
	
	UPDATE VE_THANG
	SET NGAY_KET_THUC=DATEADD(DD,30,NGAY_BAT_DAU)

END

--Mỗi ga chỉ có một bản đồ
GO
CREATE TRIGGER TRIG_BANDO_GA ON BAN_DO
FOR INSERT, UPDATE, DELETE
AS 
BEGIN
    DECLARE @DEM INT
    DECLARE @MA_GA CHAR(4)
    SELECT @MA_GA = MA_GA
    FROM INSERTED

    SELECT @DEM = COUNT(MA_BD)
    FROM BAN_DO
    WHERE MA_GA = @MA_GA
    GROUP BY MA_GA

    IF(@DEM > 1) 
        ROLLBACK
END

--Mỗi tuyến tàu chỉ có tối đa 100 vé
GO
CREATE TRIGGER TRIG_100VE ON VE
FOR INSERT, UPDATE, DELETE
AS
BEGIN
	DECLARE @DEM INT
	DECLARE @MATUYEN CHAR(4)

	SELECT @MATUYEN = MA_TUYEN
	FROM inserted

	SELECT @DEM = COUNT(MA_VE)
	FROM VE
	WHERE MA_TUYEN = @MATUYEN
	GROUP BY MA_TUYEN

	IF(@DEM > 100)
		ROLLBACK
END

--Số lần sử dung của vé tháng
GO
CREATE TRIGGER TRIG_SO_LAN_SD ON THOI_DIEM_SU_DUNG
AFTER INSERT
AS
BEGIN
	DECLARE @SO_LAN_SU_DUNG VARCHAR(100)
	DECLARE @MA_VE CHAR(4)
	DECLARE @DEM INT

	SELECT @SO_LAN_SU_DUNG = SO_LAN_SU_DUNG
	FROM INSERTED, VE_THANG 
	WHERE inserted.MA_VE = VE_THANG.MA_VE

	SELECT @MA_VE = MA_VE
	FROM INSERTED

	SET @DEM = (SELECT COUNT(MA_TD) 
				FROM  INSERTED,VE_THANG
				WHERE VE_THANG.MA_VE =INSERTED.MA_VE
				AND VE_THANG.MA_VE = @MA_VE
				GROUP BY VE_THANG.MA_VE)
	SELECT @SO_LAN_SU_DUNG = @SO_LAN_SU_DUNG + @DEM

	UPDATE VE_THANG 
	SET SO_LAN_SU_DUNG = @SO_LAN_SU_DUNG
	WHERE VE_THANG.MA_VE=@MA_VE
END

--Trị giá của vé 
GO 
CREATE TRIGGER TRIG_TRI_GIA ON VE
AFTER INSERT, UPDATE, DELETE
AS
BEGIN
	DECLARE @TRI_GIA MONEY
	DECLARE @GIA_TUYEN MONEY
	DECLARE @PHAN_TRAM_KM DECIMAL(3,2)
	DECLARE @MA_VE CHAR(4)

	SELECT @TRI_GIA = TRI_GIA, @MA_VE = MA_VE
	FROM INSERTED

	SELECT @GIA_TUYEN = GIA_TUYEN
	FROM INSERTED, TUYEN_TAU
	WHERE INSERTED.MA_TUYEN = TUYEN_TAU.MA_TUYEN

	SELECT @PHAN_TRAM_KM = PHAN_TRAM_KM
	FROM INSERTED, KHUYEN_MAI
	WHERE INSERTED.MA_KM = KHUYEN_MAI.MA_KM

	SELECT @TRI_GIA = @TRI_GIA + (@GIA_TUYEN - @GIA_TUYEN * @PHAN_TRAM_KM)

	UPDATE VE
	SET TRI_GIA = @TRI_GIA
	WHERE VE.MA_VE = @MA_VE
END

--PROCEDURE

--Tình trạng hợp lệ của vé thường là chưa sử dụng lần nào
GO
CREATE PROC PROC_TT_VETHUONG (@MA_VE CHAR(4))
AS
BEGIN
	IF ((SELECT THOI_DIEM_DUNG_VE FROM VE_THUONG WHERE MA_VE = @MA_VE) IS NULL)
		BEGIN
			UPDATE VE_THUONG
			SET TINH_TRANG_VE = N'Chưa sử dụng'
			WHERE MA_VE = @MA_VE	
			PRINT N'Vé hợp lệ'
		END
	ELSE	
		BEGIN
			UPDATE VE_THUONG
			SET TINH_TRANG_VE = N'Đã sử dụng'
			WHERE MA_VE = @MA_VE
			PRINT N'Vé không hợp lệ'
	END
END

--Tình trạng hợp lệ của vé tháng là còn hạn sử dụng
GO
CREATE PROC PROC_TT_VETHANG (@MA_VE CHAR(4))
AS
BEGIN
	
	IF (DATEDIFF(DAY, (SELECT NGAY_KET_THUC FROM VE_THANG WHERE MA_VE = @MA_VE ),
		(SELECT TOP 1 NGAY FROM THOI_DIEM_SU_DUNG WHERE MA_VE = @MA_VE ORDER BY NGAY DESC ) )<=0)
		BEGIN
			UPDATE VE_THANG
			SET TINH_TRANG_VE = N'Còn hạn'
			WHERE MA_VE = @MA_VE			
			PRINT N'Vé hợp lệ'
		END
	ELSE 
		BEGIN
			UPDATE VE_THANG
			SET TINH_TRANG_VE = N'Hết hạn'
			WHERE MA_VE = @MA_VE
			PRINT N'Vé không hợp lệ'
		END
END

--Tổng Doanh Thu
GO
CREATE PROC PROC_TONG_DT (@MA_BC CHAR(4), @NGAY_BD SMALLDATETIME, @NGAY_KT SMALLDATETIME, @TONGDT MONEY OUT  )
AS
BEGIN
    SELECT @TONGDT = SUM(TRI_GIA)
    FROM  VE
    WHERE NGAY_MUA BETWEEN @NGAY_BD AND @NGAY_KT

    UPDATE BAO_CAO 
    SET TONG_DOANH_THU = @TONGDT
    WHERE MA_BC = @MA_BC
END

--Tuyến tàu tốc hành có dừng trạm hay không?
GO
CREATE PROC PROC_DUNG_TRAM (@MA_TUYEN CHAR(4))
AS
BEGIN
	IF ((SELECT MA_GA FROM DIEM_DUNG WHERE MA_TUYEN = @MA_TUYEN) IS NULL)
		BEGIN
			UPDATE TUYEN_TOC_HANH
			SET DUNG_TRAM = 0
			WHERE MA_TUYEN = @MA_TUYEN	
			PRINT N'Không dừng trạm'
		END
	ELSE	
		BEGIN
			UPDATE TUYEN_TOC_HANH
			SET DUNG_TRAM = 1
			WHERE MA_TUYEN = @MA_TUYEN	
			PRINT N'Có dừng trạm'
	END
END


--INSERT DATA
INSERT INTO CTY_TAU_CAO_TOC(MA_CTY,TEN_CTY, WEBSITE, DIA_CHI, SDT) VALUES 
('CT01',N'Giàng A Bảy','www.giangabay.com',N'123 Lê Lợi - TP.HCM','0932546874'),
('CT02',N'Viễn Thông E','www.vienthonge.com',N'369 Lê Duẩn - TP.HCM','0354568745'),
('CT03',N'Vận Chuyển FAST','www.vanchuyenfast.com',N'752 Nguyễn Trãi - TP.HCM','0345781246'),
('CT04',N'Quản Lí Đường Bộ','www.quanliduongbo.com',N'452 Cao Bá Quát - TP.HCM','0875123548'),
('CT05',N'PeKaMech','www.pekamech.com',N'159 Quang Trung - TP.HCM','0945754224'),
('CT06',N'Tre Thánh Gióng','www.trethanhgiong.com',N'357 Lê Thánh Tông TP.HCM','0364251457'),
('CT07',N'Venus Tím','www.venustim.com',N'258 An Nhơn - TP.HCM','0912456873'),
('CT08',N'Hecquyn Hường','www.hecquynhuong.com',N'Lê Văn Việt - TP.HCM','0354786872'),
('CT09',N'Bông Sen vàng','www.bongsenvang.com',N'248 Nguyễn Huệ TP.HCM','0942354254'),
('CT10',N'Jupiter Đỏ','www.jupiterdo.com',N'168 Hai Bà Trưng TP.HCM','0354654789')


INSERT INTO GA(MA_GA, TEN_GA, VI_TRI, TINH_TRANG_GA) VALUES 
('GA01',N'Bến Thành',N'Chợ Bến Thành',N'Bình thường'),
('GA02',N'Suối Tiên',N'Suối Tiên',N'Bình thường'),
('GA03',N'Nhà Hát Thành Phố',N'Bến Nghé',N'Bình thường'),
('GA04','Ba Son',N'Bến Nghé',N'Bình thường'),
('GA05',N'Thảo Điền',N'Bình Thạnh',N'Bình thường'),
('GA06',N'Hiệp Bình Phước',N'Thủ Đức',N'Bình thường'),
('GA07',N'Thảo Cầm Viên',N'Quận 1',N'Bình thường'),
('GA08',N'Khu Công Nghệ Cao',N'Thủ Đức',N'Bình thường'),
('GA09',N'Bến Xe Miền Tây',N'Bình Tân',N'Bình thường'),
('GA10',N'Bến Xe Miền Đông Mới',N'Quận 9',N'Bình thường')

INSERT INTO BAN_DO(MA_BD,MA_GA,HINH_ANH) VALUES
('BD01','GA01','https://upload.wikimedia.org/wikipedia/commons/9/91/Ben_Thanh_market_2.jpg'),
('BD02','GA02','https://wiki-travel.com.vn/uploads/post/camnhi-202124112127-khu-du-lich-suoi-tien.jpg'),
('BD03','GA03','https://cdn.yeudulich.com/940x630/media/attraction/attraction/d7/b3/de43-63f6-4654-8157-7c10943148a0.jpg'),
('BD04','GA04','https://vinhomes-bason.vn/wp-content/uploads/sites/33/2016/01/vinhomes-golden-river-ba-son.jpg'),
('BD05','GA05','https://blog.rever.vn/hs-fs/hubfs/tam%20nhin%20tu%20Q2%20thao%20dien%20.jpg?width=793&height=500&name=tam%20nhin%20tu%20Q2%20thao%20dien%20.jpg'),
('BD06','GA06','https://upload.wikimedia.org/wikipedia/commons/e/e1/Hi%E1%BB%87p_B%C3%ACnh_Ph%C6%B0%E1%BB%9Bc%2C_Th%E1%BB%A7_%C4%90%E1%BB%A9c%2C_H%E1%BB%93_Ch%C3%AD_Minh%2C_Vietnam_-_panoramio.jpg'),
('BD07','GA07','http://3blackdogs.org/wp-content/uploads/2019/05/thao-cam-vien-co-gi-choi-top-850x478.jpg'),
('BD08','GA08','https://dongtanglong.net.vn/wp-content/uploads/2020/07/cong-vao-khu-cong-nghe-cao-quan-9-tphcm.jpg'),
('BD09','GA09','https://lh3.googleusercontent.com/proxy/OvUTKVe5sYCiKirWXWPqJzRQB3yEJzryWhpIM3AfennykysafooVYVST-NKejCU1zLziCnKqeByDoyosRysxAq88e-ArYN_VoK_fmcwr_maphSdlGA53LgOeZdwLWm7WDrkKSY5-JeBrE-3zLfAjbp5u'),
('BD10','GA10','https://vcdn-vnexpress.vnecdn.net/2020/07/28/Khu-Dong-Saigon-6-1593674302-1547-1595931336.jpg')


INSERT INTO TUYEN_TAU(MA_TUYEN, TEN_TUYEN, MA_CTY, MA_GA_XUAT_PHAT, MA_GA_KET_THUC, LOAI_TUYEN, GIA_TUYEN, TINH_TRANG_TUYEN, THOI_GIAN_BAT_DAU, THOI_GIAN_KET_THUC, THOI_GIAN_CHO) VALUES 
('TT01',N'Suối Tiên - Nhà Hát Thành Phố','CT01','GA02','GA03',N'Tuyến Tốc Hành','40000',N'Hoạt Động','6:00 ','18:00',N'10 Phút'),
('TT02',N'Bến Thành - Suối Tiên','CT02','GA01','GA02',N'Tuyến Thường','45000',N'Hoạt Động','5:30','17:30',N'15 Phút'),
('TT03',N'Bến Thành - Nhà Hát Thành Phố','CT03','GA01','GA03',N'Tuyến Thường','25000',N'Hoạt Động','6:00','18:00',N'5 Phút'),
('TT04',N'Bến Thành - Bến Xe Miền Đông Mới','CT04','GA01','GA10',N'Tuyến Thường','45000',N'Hoạt Động','5:00 ','17:00',N'10 Phút'),
('TT05',N'Thảo Điền - Bến Thành','CT05','GA05','GA01',N'Tuyến Tốc Hành','30000',N'Hoạt Động','6:00','18:00',N'10 Phút'),
('TT06',N'Ba Son - Bến Xe Miền Đông Mới','CT06','GA04','GA10',N'Tuyến Thường','35000',N'Hoạt Động','6:30 ','18:30',N'10 Phút'),
('TT07',N'Thảo Cầm Viên - Nhà Hát Thành Phố','CT07','GA07','GA03',N'Tuyến Tốc Hành','30000',N'Hoạt Động','6:00','18:00',N'15 Phút'),
('TT08',N'Hiệp Bình Phước - Ba Son','CT08','GA06','GA04',N'Tuyến Thường','30000',N'Hoạt Động','5:00 ','17:00',N'10 Phút'),
('TT09',N'Bến Xe Miền Đông Mới - Thảo Điền','CT09','GA10','GA05',N'Tuyến Thường','35000',N'Hoạt Động','5:30','17:30',N'10 Phút'),
('TT10',N'Bến Xe Miền Đông Mới - Bến Xe Miền Tây','CT10','GA10','GA09',N'Tuyến Tốc Hành','50000',N'Hoạt Động','5:30','17:30',N'10 Phút')


INSERT INTO NHAN_VIEN(MA_NV, HO_TEN, LOAI_NV, TAI_KHOAN, MAT_KHAU, MA_CTY, MA_GA, MA_TUYEN) VALUES 
('NV01',N'Mãi Không Khôn',N'Nhân viên bán vé','maikhongkhon','maikhongkhon',NULL,'GA01',NULL),
('NV02',N'Đồng Hồ Thuỵ Sỹ',N'Nhân viên bán vé','donghothuysi','donghothuysi',NULL,'GA02',NULL),
('NV03',N'Trương Vô Kỵ',N'Nhân viên bán vé','truongvoky','truongvoky',NULL,'GA03',NULL),
('NV04',N'Lò Vi Sóng',N'Nhân viên công ty','lovisong','lovisong','CT03',NULL,NULL),
('NV05',N'Hài Thật Đấy',N'Nhân viên sở GTTP','haithatday','haithatday',NULL,NULL,NULL)


INSERT INTO KHUYEN_MAI(MA_KM, NOI_DUNG, PHAN_TRAM_KM,LOAI_DT) VALUES 
('KM01',N'KM cho HS-SV',0.1,N'HS-SV'),
('KM02',N'KM cho Trẻ Nhỏ (<5)',0.2,N'Trẻ Nhỏ (<5)'),
('KM03',N'KM cho Trẻ Em (5-10)',0.15,N'Trẻ Em (5-10)'),
('KM04',N'KM cho Người cao tuổi (>65)',0.25,N'Người cao tuổi (>65)'),
('KM05',N'KM cho Người khuyết tật',0.3,N'Người khuyết tật')

INSERT INTO DIEM_DUNG(MA_GA,MA_TUYEN,THOI_GIAN_DUNG) VALUES 
('GA01','TT01',N'10 phút'),
('GA02','TT02',N'10 phút'),
('GA03','TT03',N'10 phút')


--Xử lí vi phạm 
--LOST UPDATE
--TRANSACTION 1
--SET TRANSACTION ISOLATION LEVEL REPEATABLE READ
BEGIN TRAN T1_LOSTUPDATE
DECLARE @GIA_TUYEN MONEY

SELECT @GIA_TUYEN= GIA_TUYEN 
FROM TUYEN_TAU 
WHERE MA_TUYEN='TT01'

waitfor delay '00:00:10'
SET @GIA_TUYEN= @GIA_TUYEN + 5000

UPDATE TUYEN_TAU
SET GIA_TUYEN = @GIA_TUYEN 
WHERE MA_TUYEN = 'TT01'

PRINT @GIA_TUYEN
COMMIT TRAN T1_LOSTUPDATE
--TRANSACTION 2
--SET TRANSACTION ISOLATION LEVEL REPEATABLE READ
BEGIN TRAN T2_LOSTUPDATE
DECLARE @GIA_TUYEN MONEY
SELECT @GIA_TUYEN= GIA_TUYEN 
FROM TUYEN_TAU 
WHERE MA_TUYEN='TT01'
waitfor delay '00:00:01'
SET @GIA_TUYEN= @GIA_TUYEN + 10000

UPDATE TUYEN_TAU
SET GIA_TUYEN = @GIA_TUYEN 
WHERE MA_TUYEN = 'TT01'

PRINT @GIA_TUYEN
COMMIT TRAN T2_LOSTUPDATE
--DIRTY READ
--TRANSACTION 1
SELECT TINH_TRANG_GA FROM GA WHERE MA_GA = 'GA02'

BEGIN TRAN DIRTY_READ
UPDATE GA SET TINH_TRANG_GA =N'Đang sửa chữa' WHERE MA_GA = 'GA02'
WAITFOR DELAY '00:00:10'
ROLLBACK TRANSACTION DIRTY_READ
--TRANSACTION 2
--SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
--SET TRANSACTION ISOLATION LEVEL READ COMMITTED
SELECT TINH_TRANG_GA FROM GA WHERE MA_GA = 'GA02'

--NONREPEATABLE READ
--TRANSACTION 1
--SET TRANSACTION ISOLATION LEVEL REPEATABLE READ
BEGIN TRAN NONREPEATABLE_READ
SELECT TINH_TRANG_TUYEN FROM TUYEN_TAU WHERE MA_TUYEN ='TT01'

WAITFOR DELAY '00:00:05'

SELECT TINH_TRANG_TUYEN FROM TUYEN_TAU WHERE MA_TUYEN ='TT01'
COMMIT TRANSACTION NONREPEATABLE_READ
--TRANSACTION 2
UPDATE TUYEN_TAU 
SET TINH_TRANG_TUYEN = N'Không hoạt động' 
WHERE MA_TUYEN='TT01'
--UPDATE TUYEN_TAU SET TINH_TRANG_TUYEN =N'Hoạt động' where MA_TUYEN='TT01'

--PHANTOM READ
--TRANSACTION 1
--SET TRANSACTION ISOLATION LEVEL SERIALIZABLE
BEGIN TRAN PHANTOM_READ
SELECT * FROM CTY_TAU_CAO_TOC

WAITFOR DELAY '00:00:10'

SELECT * FROM CTY_TAU_CAO_TOC
COMMIT TRANSACTION PHANTOM_READ
--TRANSACTION 2
INSERT INTO CTY_TAU_CAO_TOC VALUES ('CT11',N'Vận chuyển A','www.vanchuyena.com',N'123 Nguyễn Huệ - TP.HCM','0326564126')
--DELETE FROM CTY_TAU_CAO_TOC WHERE MA_CTY ='CT11'

--DEADLOCK
--TRANSACTION 1
BEGIN TRAN T1
UPDATE TUYEN_TAU 
SET TINH_TRANG_TUYEN =N'Không hoạt động'
WHERE MA_TUYEN IN ('TT01','TT02')

UPDATE DIEM_DUNG 
SET THOI_GIAN_DUNG =N'10 phút'
WHERE MA_TUYEN = 'TT03'
COMMIT TRAN T1
--TRANSACTION 2
BEGIN TRAN T2
UPDATE DIEM_DUNG 
SET THOI_GIAN_DUNG =N'10 phút'
WHERE MA_TUYEN = 'TT03'

UPDATE TUYEN_TAU 
SET TINH_TRANG_TUYEN =N'Không hoạt động'
WHERE MA_TUYEN IN ('TT01','TT02')
COMMIT TRAN T2

--DEADLOCK PRIORITY
--TRANSACTION 1
BEGIN TRAN T1
UPDATE TUYEN_TAU 
SET TINH_TRANG_TUYEN =N'Không hoạt động'
WHERE MA_TUYEN IN ('TT01','TT02')

UPDATE DIEM_DUNG 
SET THOI_GIAN_DUNG =N'15 phút'
WHERE MA_TUYEN = 'TT03'
COMMIT TRAN T1
--TRANSACTION 2
SET DEADLOCK_PRIORITY HIGH
BEGIN TRAN T2
UPDATE DIEM_DUNG 
SET THOI_GIAN_DUNG =N'15 phút'
WHERE MA_TUYEN = 'TT03'

UPDATE TUYEN_TAU 
SET TINH_TRANG_TUYEN =N'Không hoạt động'
WHERE MA_TUYEN IN ('TT01','TT02')
COMMIT TRAN T2
--BLOCK INSERT
--TRANSACTION 1
SELECT * FROM GA

BEGIN TRAN T1
INSERT INTO GA VALUES ('GA11',N'Ngã Tư Thủ Đức',N'Ngã Tư Thủ Đức',N'Bình thường')
COMMIT TRAN T1
SELECT * FROM GA
--TRANSACTION 2
SELECT * FROM GA

BEGIN TRAN T2
INSERT INTO GA VALUES ('GA11',N'Ngã Tư Thủ Đức',N'Ngã Tư Thủ Đức',N'Đang sửa chữa')
SELECT * FROM GA

--BLOCK UPDATE
--TRANSACTION 1
BEGIN TRAN T1
UPDATE GA 
SET TINH_TRANG_GA =N'Đang sửa chữa'
WHERE MA_GA ='GA11'
COMMIT TRAN T1

SELECT * FROM GA

--TRANSACTION 2
BEGIN TRAN T2
UPDATE GA 
SET TINH_TRANG_GA =N'Ngừng hoạt động'
WHERE MA_GA ='GA11'
COMMIT TRAN T2

SELECT * FROM GA

